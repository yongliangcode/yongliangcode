<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="aFajlZ_qxnHSidfrI7ZwIC5dtkVavvKdk7iYyjMrG3c">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yongliangcode.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="引言本文接着撸Distro协议，上文中分析了寻址模式。有了地址就要建立连接，有了连接就能通信了。集群之间都交互啥数据？本文就扒一扒全量同步和节点之间数据校验。 内容提要节点间建立RCP连接 订阅了MembersChangeEvent事件，集群节点有变更能够收到回调通知 与集群中其他节点建立grpc连接并缓存到Map其中key格式为「Cluster-IP:Port」  节点间校验数据通信 节点之间发">
<meta property="og:type" content="article">
<meta property="og:title" content="Nacos6# Distro协议全量同步与校验">
<meta property="og:url" content="https://yongliangcode.github.io/posts/c1f9abd4/index.html">
<meta property="og:site_name" content="瓜农老梁">
<meta property="og:description" content="引言本文接着撸Distro协议，上文中分析了寻址模式。有了地址就要建立连接，有了连接就能通信了。集群之间都交互啥数据？本文就扒一扒全量同步和节点之间数据校验。 内容提要节点间建立RCP连接 订阅了MembersChangeEvent事件，集群节点有变更能够收到回调通知 与集群中其他节点建立grpc连接并缓存到Map其中key格式为「Cluster-IP:Port」  节点间校验数据通信 节点之间发">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-06-26T03:55:01.000Z">
<meta property="article:modified_time" content="2021-08-01T06:11:03.877Z">
<meta property="article:tag" content="Nacos">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://yongliangcode.github.io/posts/c1f9abd4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Nacos6# Distro协议全量同步与校验 | 瓜农老梁</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">瓜农老梁</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一个想分享点干货的家伙，微信公众号「瓜农老梁」</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/c1f9abd4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nacos6# Distro协议全量同步与校验
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-26 11:55:01" itemprop="dateCreated datePublished" datetime="2021-06-26T11:55:01+08:00">2021-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-01 14:11:03" itemprop="dateModified" datetime="2021-08-01T14:11:03+08:00">2021-08-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Nacos/" itemprop="url" rel="index"><span itemprop="name">Nacos</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <div id="vip-container"><h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>本文接着撸Distro协议，上文中分析了寻址模式。有了地址就要建立连接，有了连接就能通信了。集群之间都交互啥数据？本文就扒一扒全量同步和节点之间数据校验。</p>
<h1 id="内容提要"><a href="#内容提要" class="headerlink" title="内容提要"></a>内容提要</h1><h3 id="节点间建立RCP连接"><a href="#节点间建立RCP连接" class="headerlink" title="节点间建立RCP连接"></a>节点间建立RCP连接</h3><ul>
<li>订阅了MembersChangeEvent事件，集群节点有变更能够收到回调通知</li>
<li>与集群中其他节点建立grpc连接并缓存到Map其中key格式为「Cluster-IP:Port」</li>
</ul>
<h3 id="节点间校验数据通信"><a href="#节点间校验数据通信" class="headerlink" title="节点间校验数据通信"></a>节点间校验数据通信</h3><ul>
<li>节点之间发送校验数据是在全量同步后进行的</li>
<li>发送校验的频率默认为5秒钟一次</li>
<li>校验数据包括clientId和version，其中version为保留字段当前为0</li>
<li>接受到校验数据后如果缓存中存在该client表示校验成功，同时更新保鲜时间，否则校验失败</li>
</ul>
<h3 id="全量数据同步"><a href="#全量数据同步" class="headerlink" title="全量数据同步"></a>全量数据同步</h3><ul>
<li>在节点启动时会从集群中其他节点中的一个节点同步快照数据并缓存在Map中</li>
<li>缓存的数据类型分类两类分别为HTTP和gRPC</li>
<li>具体数据即客户端注册节点信息含命名空间、分组名称、服务名称、节点Instance信息等</li>
<li>集群中每个节点都拥有所有的快照数据</li>
</ul>
<a id="more"></a>



<h1 id="节点间建立RPC连接"><a href="#节点间建立RPC连接" class="headerlink" title="节点间建立RPC连接"></a>节点间建立RPC连接</h1><p>节点之间要通信，需要建立连接。Nacos集群节点之间也不例外，下面看下Nacos是如何和集群之间建立连接的，以gRPC为例。</p>
<p>Nacos中ClusterRpcClientProxy封装了集群中节点之间的通道。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 注解@1</span></span><br><span class="line">    NotifyCenter.registerSubscriber(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// 注解@2</span></span><br><span class="line">    List&lt;Member&gt; members = serverMemberManager.allMembersWithoutSelf(); </span><br><span class="line">    <span class="comment">// 注解@3</span></span><br><span class="line">    refresh(members);</span><br><span class="line">    Loggers.CLUSTER</span><br><span class="line">      .warn(<span class="string">&quot;[ClusterRpcClientProxy] success to refresh cluster rpc client on start up,members =&#123;&#125; &quot;</span>,</span><br><span class="line">            members);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">    Loggers.CLUSTER.warn(<span class="string">&quot;[ClusterRpcClientProxy] fail to refresh cluster rpc client,&#123;&#125; &quot;</span>, e.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@1</strong> 注册自己订阅MembersChangeEvent事件</p>
<p><strong>注解@2</strong> 获取集群中的节点列表剔除自身节点</p>
<p><strong>注解@3</strong> 与各个节点建立rpc通道</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">(List&lt;Member&gt; members)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">	  <span class="keyword">for</span> (Member member : members) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (MemberUtil.isSupportedLongCon(member)) &#123;</span><br><span class="line">            <span class="comment">// 注解@3.1</span></span><br><span class="line">            createRpcClientAndStart(member, ConnectionType.GRPC);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	  Set&lt;Map.Entry&lt;String, RpcClient&gt;&gt; allClientEntrys = RpcClientFactory.getAllClientEntries();</span><br><span class="line">    Iterator&lt;Map.Entry&lt;String, RpcClient&gt;&gt; iterator = allClientEntrys.iterator();</span><br><span class="line">    List&lt;String&gt; newMemberKeys = members.stream().filter(a -&gt; MemberUtil.isSupportedLongCon(a))</span><br><span class="line">            .map(a -&gt; memberClientKey(a)).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 注解@3.2</span></span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        Map.Entry&lt;String, RpcClient&gt; next1 = iterator.next();</span><br><span class="line">        <span class="keyword">if</span> (next1.getKey().startsWith(<span class="string">&quot;Cluster-&quot;</span>) &amp;&amp; !newMemberKeys.contains(next1.getKey())) &#123;</span><br><span class="line">            Loggers.CLUSTER.info(<span class="string">&quot;member leave,destroy client of member - &gt; : &#123;&#125;&quot;</span>, next1.getKey());</span><br><span class="line">            RpcClientFactory.getClient(next1.getKey()).shutdown();</span><br><span class="line">            iterator.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@3.1</strong> 为集群中每个节点member创建rcp client</p>
<p><strong>注解@3.2</strong> 关闭旧的grpc连接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createRpcClientAndStart</span><span class="params">(Member member, ConnectionType type)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">    Map&lt;String, String&gt; labels = <span class="keyword">new</span> HashMap&lt;String, String&gt;(<span class="number">2</span>);</span><br><span class="line">    labels.put(RemoteConstants.LABEL_SOURCE, RemoteConstants.LABEL_SOURCE_CLUSTER);</span><br><span class="line">    <span class="comment">// 注解@3.1.1</span></span><br><span class="line">    String memberClientKey = memberClientKey(member);</span><br><span class="line">    RpcClient client = RpcClientFactory.createClusterClient(memberClientKey, type, labels);</span><br><span class="line">    <span class="keyword">if</span> (!client.getConnectionType().equals(type)) &#123;</span><br><span class="line">        Loggers.CLUSTER.info(<span class="string">&quot;,connection type changed,destroy client of member - &gt; : &#123;&#125;&quot;</span>, member);</span><br><span class="line">        RpcClientFactory.destroyClient(memberClientKey);</span><br><span class="line">        <span class="comment">// 注解@3.1.2</span></span><br><span class="line">        client = RpcClientFactory.createClusterClient(memberClientKey, type, labels);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (client.isWaitInitiated()) &#123;</span><br><span class="line">        Loggers.CLUSTER.info(<span class="string">&quot;start a new rpc client to member - &gt; : &#123;&#125;&quot;</span>, member);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注解@3.1.3</span></span><br><span class="line">        client.serverListFactory(<span class="keyword">new</span> ServerListFactory() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">genNextServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> member.getAddress(); <span class="comment">// 返回连接集群其他节点地址</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getCurrentServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> member.getAddress();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getServerList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Lists.newArrayList(member.getAddress());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 注解@3.1.4</span></span><br><span class="line">        client.start(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@3.1.1</strong> memberClientKey由「Cluster-IP:Port」构成，例如：Cluster-1.2.3.4:2008</p>
<p><strong>注解@3.1.2</strong> 创建grpc client并缓存在 clientMap，key为memberClientKey 此时client的状态为WAIT_INIT</p>
<p><strong>注解@3.1.3</strong> 集群中固定的某一台节点</p>
<p><strong>注解@3.1.4</strong>  grpc连接集群中的member节点设置client的状态RUNNING</p>
<p><strong>小结：</strong> 在与Nacos集群其他节点建立连接的过程中做了两件事情：@1.订阅了MembersChangeEvent事件 @2.与集群中其他节点建立grpc连接并缓存到Map其中key格式为「Cluster-IP:Port」。</p>
<h1 id="节点间校验数据通信-1"><a href="#节点间校验数据通信-1" class="headerlink" title="节点间校验数据通信"></a>节点间校验数据通信</h1><p>节点之间建立rpc通道必然是为了互相之间能通信，其中一个通信是节点之间发送校验数据。那为什么要发这些校验数据？这些数据都是些什么内容？下面咱就去扒一扒。</p>
<p>在DistroProtocol的构造函数中的最后一个行有一个startDistroTask()，主要分析startVerifyTask的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DistroProtocol</span><span class="params">(ServerMemberManager memberManager, DistroComponentHolder distroComponentHolder,</span></span></span><br><span class="line"><span class="function"><span class="params">        DistroTaskEngineHolder distroTaskEngineHolder, DistroConfig distroConfig)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.memberManager = memberManager;</span><br><span class="line">    <span class="keyword">this</span>.distroComponentHolder = distroComponentHolder;</span><br><span class="line">    <span class="keyword">this</span>.distroTaskEngineHolder = distroTaskEngineHolder;</span><br><span class="line">    <span class="keyword">this</span>.distroConfig = distroConfig;</span><br><span class="line">    startDistroTask();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startDistroTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 单机模式直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (EnvUtil.getStandaloneMode()) &#123;</span><br><span class="line">        isInitialized = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    startVerifyTask();</span><br><span class="line">    startLoadTask();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startVerifyTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// 注解@4</span></span><br><span class="line">    GlobalExecutor.schedulePartitionDataTimedSync(<span class="keyword">new</span> DistroVerifyTimedTask(memberManager, distroComponentHolder,</span><br><span class="line">            distroTaskEngineHolder.getExecuteWorkersManager()), distroConfig.getVerifyIntervalMillis());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@4</strong>  每隔5秒执行，也就是节点之间发送校验时间的默认频率是5秒。</p>
<p>​               可以通过配置参数「nacos.core.protocol.distro.data.verify_interval_ms」自定义。</p>
<p>接着看DistroVerifyTimedTask的run方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 注解@5</span></span><br><span class="line">        List&lt;Member&gt; targetServer = serverMemberManager.allMembersWithoutSelf();</span><br><span class="line">        <span class="keyword">if</span> (Loggers.DISTRO.isDebugEnabled()) &#123;</span><br><span class="line">            Loggers.DISTRO.debug(<span class="string">&quot;server list is: &#123;&#125;&quot;</span>, targetServer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注解@6</span></span><br><span class="line">        <span class="keyword">for</span> (String each : distroComponentHolder.getDataStorageTypes()) &#123;</span><br><span class="line">            verifyForDataStorage(each, targetServer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Loggers.DISTRO.error(<span class="string">&quot;[DISTRO-FAILED] verify task failed.&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@5</strong> 拿到集群中其他节点</p>
<p><strong>注解@6</strong> 在Nacos server启动时初始化时两种类型HTTP和gRPC，本文以gRPC为例进行分析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">verifyForDataStorage</span><span class="params">(String type, List&lt;Member&gt; targetServer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 注解@7</span></span><br><span class="line">    DistroDataStorage dataStorage = distroComponentHolder.findDataStorage(type);</span><br><span class="line">    <span class="comment">// 注解@8</span></span><br><span class="line">    <span class="keyword">if</span> (!dataStorage.isFinishInitial()) &#123;  <span class="comment">// 未完成全量数据同步退出</span></span><br><span class="line">        Loggers.DISTRO.warn(<span class="string">&quot;data storage &#123;&#125; has not finished initial step, do not send verify data&quot;</span>,</span><br><span class="line">                dataStorage.getClass().getSimpleName());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注解@9</span></span><br><span class="line">    List&lt;DistroData&gt; verifyData = dataStorage.getVerifyData();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == verifyData || verifyData.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Member member : targetServer) &#123;</span><br><span class="line">        DistroTransportAgent agent = distroComponentHolder.findTransportAgent(type);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == agent) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// 注解@10</span></span><br><span class="line">        executeTaskExecuteEngine.addTask(member.getAddress() + type,</span><br><span class="line">                <span class="keyword">new</span> DistroVerifyExecuteTask(agent, verifyData, member.getAddress(), type));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@7</strong> Nacos启动时缓存在dataStorageMap中两种类型处理器分别用于处理gRPC和HTTP通信方式。</p>
<p>「Nacos:Naming:v2:ClientData-&gt;DistroClientDataProcessor」和 「com.alibaba.nacos.naming.iplist.-&gt;DistroDataStorageImpl」</p>
<p><strong>注解@8</strong> 当从其他节点同步了全部数据后，则完成了初始化finished initial，全量数据同步下小节分析。</p>
<p><strong>注解@9</strong>  获取校验的数据，数据为由本节点负责的clientId列表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;DistroData&gt; <span class="title">getVerifyData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;DistroData&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// 一组DistroData</span></span><br><span class="line">    <span class="keyword">for</span> (String each : clientManager.allClientId()) &#123;</span><br><span class="line">        Client client = clientManager.getClient(each);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == client || !client.isEphemeral()) &#123; <span class="comment">// 无效client或者非临时节点</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注解@9.1</span></span><br><span class="line">        <span class="keyword">if</span> (clientManager.isResponsibleClient(client)) &#123;</span><br><span class="line">            <span class="comment">// 注解@9.2</span></span><br><span class="line">            DistroClientVerifyInfo verifyData = <span class="keyword">new</span> DistroClientVerifyInfo(client.getClientId(), <span class="number">0</span>);</span><br><span class="line">            DistroKey distroKey = <span class="keyword">new</span> DistroKey(client.getClientId(), TYPE);</span><br><span class="line">            DistroData data = <span class="keyword">new</span> DistroData(distroKey,</span><br><span class="line">                    ApplicationUtils.getBean(Serializer.class).serialize(verifyData)); <span class="comment">// 序列化校验数据</span></span><br><span class="line">            data.setType(DataOperation.VERIFY);</span><br><span class="line">            result.add(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@9.1</strong> 判断client是否为本几点负责的逻辑为ClientManagerDelegate#isResponsibleClient。即：属于ConnectionBasedClient并且</p>
<p>isNative为true表示该client是直连到该节点的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isResponsibleClient</span><span class="params">(Client client)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (client <span class="keyword">instanceof</span> ConnectionBasedClient) &amp;&amp; ((ConnectionBasedClient) client).isNative();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@9.2</strong> 构造Verify Data 主要信息为clientId，还有一个版本信息作为保留字段，目前都是0。</p>
<p><strong>注解@10</strong> 向集群其他节点发送校验数据DistroVerifyExecuteTask#run</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (DistroData each : verifyData) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (transportAgent.supportCallbackTransport()) &#123; <span class="comment">// grpc支持回调</span></span><br><span class="line">                doSyncVerifyDataWithCallback(each);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// http不支持回调使用同步</span></span><br><span class="line">                doSyncVerifyData(each);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">syncVerifyData</span><span class="params">(DistroData verifyData, String targetServer, DistroCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isNoExistTarget(targetServer)) &#123;</span><br><span class="line">        callback.onSuccess();</span><br><span class="line">    &#125;</span><br><span class="line">    DistroDataRequest request = <span class="keyword">new</span> DistroDataRequest(verifyData, DataOperation.VERIFY);</span><br><span class="line">    Member member = memberManager.find(targetServer);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        DistroVerifyCallbackWrapper wrapper = <span class="keyword">new</span> DistroVerifyCallbackWrapper(targetServer,</span><br><span class="line">                verifyData.getDistroKey().getResourceKey(), callback, member);</span><br><span class="line">       	<span class="comment">// 注解@11         </span></span><br><span class="line">        clusterRpcClientProxy.asyncRequest(member, request, wrapper); </span><br><span class="line">    &#125; <span class="keyword">catch</span> (NacosException nacosException) &#123;</span><br><span class="line">        callback.onFailed(nacosException);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@11</strong> 向其他节点发送本节点负责的clientId信息</p>
<p><strong>那集群其他节点接收到校验数据做什么处理呢?</strong> </p>
<p>翻到DistroDataRequestHandler#handle，此处包含了处理校验数据的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DistroDataResponse <span class="title">handle</span><span class="params">(DistroDataRequest request, RequestMeta meta)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (request.getDataOperation()) &#123;</span><br><span class="line">            <span class="keyword">case</span> VERIFY:</span><br><span class="line">                <span class="keyword">return</span> handleVerify(request.getDistroData(), meta);</span><br><span class="line">            <span class="keyword">case</span> SNAPSHOT:</span><br><span class="line">                <span class="keyword">return</span> handleSnapshot();</span><br><span class="line">            <span class="keyword">case</span> ADD:</span><br><span class="line">            <span class="keyword">case</span> CHANGE:</span><br><span class="line">            <span class="keyword">case</span> DELETE:</span><br><span class="line">                <span class="keyword">return</span> handleSyncData(request.getDistroData());</span><br><span class="line">            <span class="keyword">case</span> QUERY:</span><br><span class="line">                <span class="keyword">return</span> handleQueryData(request.getDistroData());</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> DistroDataResponse();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> DistroDataResponse <span class="title">handleVerify</span><span class="params">(DistroData distroData, RequestMeta meta)</span> </span>&#123;</span><br><span class="line">    DistroDataResponse result = <span class="keyword">new</span> DistroDataResponse();</span><br><span class="line">  	<span class="comment">// 注解@12</span></span><br><span class="line">    <span class="keyword">if</span> (!distroProtocol.onVerify(distroData, meta.getClientIp())) &#123;</span><br><span class="line">        result.setErrorInfo(ResponseCode.FAIL.getCode(), <span class="string">&quot;[DISTRO-FAILED] distro data verify failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@12</strong> 数据校验，下面可以看到，如果缓存存在client则校验成功，刷新client保鲜时间，否则校验失败。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verifyClient</span><span class="params">(String clientId)</span> </span>&#123;</span><br><span class="line">    ConnectionBasedClient client = clients.get(clientId);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != client) &#123;</span><br><span class="line">        client.setLastRenewTime();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>小结：</strong> 节点之间发送校验数据是在全量同步后进行的；发送校验的频率默认为5秒钟一次；校验数据包括clientId和version，其中version为保留字段当前为0；接受到校验数据后如果缓存中存在该client表示校验成功，同时更新保鲜时间，否则校验失败。</p>
<h1 id="全量数据同步-1"><a href="#全量数据同步-1" class="headerlink" title="全量数据同步"></a>全量数据同步</h1><p>上文中提到在发送校验数据之前需要先完成全量数据同步，先翻回DistroProtocol#startDistroTask()方法的startLoadTask()部分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startLoadTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DistroCallback loadCallback = <span class="keyword">new</span> DistroCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            isInitialized = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailed</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">            isInitialized = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    GlobalExecutor.submitLoadDataTask(</span><br><span class="line">            <span class="keyword">new</span> DistroLoadDataTask(memberManager, distroComponentHolder, distroConfig, loadCallback));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DistroLoadDataTask#run</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    load(); <span class="comment">// 注解@13</span></span><br><span class="line">    <span class="keyword">if</span> (!checkCompleted()) &#123; <span class="comment">// 注解@14</span></span><br><span class="line">      GlobalExecutor.submitLoadDataTask(<span class="keyword">this</span>, distroConfig.getLoadDataRetryDelayMillis());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      loadCallback.onSuccess();</span><br><span class="line">      Loggers.DISTRO.info(<span class="string">&quot;[DISTRO-INIT] load snapshot data success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    loadCallback.onFailed(e);</span><br><span class="line">    Loggers.DISTRO.error(<span class="string">&quot;[DISTRO-INIT] load snapshot data failed. &quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@13</strong> 从集群中其他节点全量加载数据</p>
<p><strong>注解@14</strong> 如果没有加载成功延迟30秒钟重新执行一次，可以通过参数「nacos.core.protocol.distro.data.load_retry_delay_ms」指定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (memberManager.allMembersWithoutSelf().isEmpty()) &#123;</span><br><span class="line">        Loggers.DISTRO.info(<span class="string">&quot;[DISTRO-INIT] waiting server list init...&quot;</span>);</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (distroComponentHolder.getDataStorageTypes().isEmpty()) &#123;</span><br><span class="line">        Loggers.DISTRO.info(<span class="string">&quot;[DISTRO-INIT] waiting distro data storage register...&quot;</span>);</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String each : distroComponentHolder.getDataStorageTypes()) &#123; <span class="comment">// 注解@15</span></span><br><span class="line">        <span class="keyword">if</span> (!loadCompletedMap.containsKey(each) || !loadCompletedMap.get(each)) &#123;</span><br><span class="line">            loadCompletedMap.put(each, loadAllDataSnapshotFromRemote(each)); <span class="comment">// 加载快照</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@15</strong> 为不同的数据类型缓存快照，此处有gRPC和http两类数据类型。即： Nacos:Naming:v2:ClientData和com.alibaba.nacos.naming.iplist.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">loadAllDataSnapshotFromRemote</span><span class="params">(String resourceType)</span> </span>&#123;</span><br><span class="line">    DistroTransportAgent transportAgent = distroComponentHolder.findTransportAgent(resourceType);</span><br><span class="line">    DistroDataProcessor dataProcessor = distroComponentHolder.findDataProcessor(resourceType);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == transportAgent || <span class="keyword">null</span> == dataProcessor) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Member each : memberManager.allMembersWithoutSelf()) &#123; <span class="comment">// 注解@16</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          	DistroData distroData = transportAgent.getDatumSnapshot(each.getAddress());</span><br><span class="line">            <span class="keyword">boolean</span> result = dataProcessor.processSnapshot(distroData);</span><br><span class="line">            <span class="keyword">if</span> (result) &#123;</span><br><span class="line">                distroComponentHolder.findDataStorage(resourceType).finishInitial(); <span class="comment">// 设置为完成初始化</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注解@16</strong> 获取集群中除了本节点的其他节点，循环重试获取快照，直到有成功节点返回快照，成功后设置状态状态完成初始化「finishInitial」。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DistroData <span class="title">getDatumSnapshot</span><span class="params">(String targetServer)</span> </span>&#123;</span><br><span class="line">    Member member = memberManager.find(targetServer);</span><br><span class="line">    <span class="keyword">if</span> (checkTargetServerStatusUnhealthy(member)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> DistroException(</span><br><span class="line">                String.format(<span class="string">&quot;[DISTRO] Cancel get snapshot caused by target server %s unhealthy&quot;</span>, targetServer));</span><br><span class="line">    &#125;</span><br><span class="line">    DistroDataRequest request = <span class="keyword">new</span> DistroDataRequest();</span><br><span class="line">  	<span class="comment">// 设置请求操作为SNAPSHOT</span></span><br><span class="line">    request.setDataOperation(DataOperation.SNAPSHOT); </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      	<span class="comment">// 发起请求快照数据</span></span><br><span class="line">        Response response = clusterRpcClientProxy.sendRequest(member, request);</span><br><span class="line">        <span class="keyword">if</span> (checkResponse(response)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((DistroDataResponse) response).getDistroData();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> DistroException(</span><br><span class="line">                    String.format(<span class="string">&quot;[DISTRO-FAILED] Get snapshot request to %s failed, code: %d, message: %s&quot;</span>,</span><br><span class="line">                            targetServer, response.getErrorCode(), response.getMessage()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> DistroException(<span class="string">&quot;[DISTRO-FAILED] Get distro snapshot failed! &quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>接下来看看其他节点收到快照请求如何响应的</strong> </p>
<p>还是翻到DistroDataRequestHandler#handle，具体由handleSnapshot()方法来处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> DistroDataResponse <span class="title">handleSnapshot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DistroDataResponse result = <span class="keyword">new</span> DistroDataResponse();</span><br><span class="line">    DistroData distroData = distroProtocol.onSnapshot(DistroClientDataProcessor.TYPE);</span><br><span class="line">    result.setDistroData(distroData);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DistroData <span class="title">getDatumSnapshot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;ClientSyncData&gt; datum = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 把本节点的所有client数据全部封装</span></span><br><span class="line">    <span class="keyword">for</span> (String each : clientManager.allClientId()) &#123;</span><br><span class="line">        Client client = clientManager.getClient(each);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == client || !client.isEphemeral()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        datum.add(client.generateSyncData());</span><br><span class="line">    &#125;</span><br><span class="line">    ClientSyncDatumSnapshot snapshot = <span class="keyword">new</span> ClientSyncDatumSnapshot();</span><br><span class="line">    snapshot.setClientSyncDataList(datum);</span><br><span class="line">    <span class="keyword">byte</span>[] data = ApplicationUtils.getBean(Serializer.class).serialize(snapshot); <span class="comment">// 序列化数据</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DistroData(<span class="keyword">new</span> DistroKey(DataOperation.SNAPSHOT.name(), TYPE), data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面看下client数据信息，命名空间、分组名称、服务名称、节点Instance信息（IP、端口等等）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ClientSyncData <span class="title">generateSyncData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; namespaces = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; groupNames = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; serviceNames = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    List&lt;InstancePublishInfo&gt; instances = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Service, InstancePublishInfo&gt; entry : publishers.entrySet()) &#123;</span><br><span class="line">        namespaces.add(entry.getKey().getNamespace());</span><br><span class="line">        groupNames.add(entry.getKey().getGroup());</span><br><span class="line">        serviceNames.add(entry.getKey().getName());</span><br><span class="line">        instances.add(entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ClientSyncData(getClientId(), namespaces, groupNames, serviceNames, instances);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>小结：</strong>集群中每个节点都拥有所有的快照数据； 在节点启动时会从集群中其他节点中的一个节点同步快照数据并缓存在Map中；缓存的数据类型分类两类分别为HTTP和gRPC；具体数据即客户端注册节点信息含命名空间、分组名称、服务名称、节点Instance信息等。</p>
</div>

			<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
			<script>
			var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);
			if (!isMobile) {
			    var btw = new BTWPlugin();
			    btw.init({
			        "id": "vip-container",
			        "blogId": "19728-1607829271089-768",
			        "name": "瓜农老梁",
			        "qrcode": "https://img-blog.csdnimg.cn/2020121311123065.jpg",
			        "keyword": "more"
			    });
			}
			</script>
		
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Nacos/" rel="tag"># Nacos</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/3266629d/" rel="prev" title="SK8# 过一种笃定的生活">
      <i class="fa fa-chevron-left"></i> SK8# 过一种笃定的生活
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/765f2ae1/" rel="next" title="Nacos8# 集群中节点之间健康检查">
      Nacos8# 集群中节点之间健康检查 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%95%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%AE%B9%E6%8F%90%E8%A6%81"><span class="nav-number">2.</span> <span class="nav-text">内容提要</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E9%97%B4%E5%BB%BA%E7%AB%8BRCP%E8%BF%9E%E6%8E%A5"><span class="nav-number">2.0.1.</span> <span class="nav-text">节点间建立RCP连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E9%97%B4%E6%A0%A1%E9%AA%8C%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1"><span class="nav-number">2.0.2.</span> <span class="nav-text">节点间校验数据通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E9%87%8F%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="nav-number">2.0.3.</span> <span class="nav-text">全量数据同步</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E9%97%B4%E5%BB%BA%E7%AB%8BRPC%E8%BF%9E%E6%8E%A5"><span class="nav-number">3.</span> <span class="nav-text">节点间建立RPC连接</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E9%97%B4%E6%A0%A1%E9%AA%8C%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1-1"><span class="nav-number">4.</span> <span class="nav-text">节点间校验数据通信</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%A8%E9%87%8F%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5-1"><span class="nav-number">5.</span> <span class="nav-text">全量数据同步</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://mp.weixin.qq.com/s/kPx7F1iD1lgvYiZ1_oymwQ" title="联系老梁 → https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;kPx7F1iD1lgvYiZ1_oymwQ" rel="noopener" target="_blank"><i class="fa fa-weixin fa-fw"></i>联系老梁</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
