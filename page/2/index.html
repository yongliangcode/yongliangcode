<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="aFajlZ_qxnHSidfrI7ZwIC5dtkVavvKdk7iYyjMrG3c">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yongliangcode.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="瓜农老梁">
<meta property="og:url" content="https://yongliangcode.github.io/page/2/index.html">
<meta property="og:site_name" content="瓜农老梁">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://yongliangcode.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>瓜农老梁</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">瓜农老梁</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一个想分享点干货的家伙，微信公众号「瓜农老梁」</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/4ce86841/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/4ce86841/" class="post-title-link" itemprop="url">Nacos15# Nacos配置中心核心原理提要</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-26 11:55:01" itemprop="dateCreated datePublished" datetime="2021-08-26T11:55:01+08:00">2021-08-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-12 11:50:17" itemprop="dateModified" datetime="2022-01-12T11:50:17+08:00">2022-01-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Nacos/" itemprop="url" rel="index"><span itemprop="name">Nacos</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>通过对Nacos配置中心源码阅读，将其核心原理归纳提炼。包含：客户端逻辑和服务端逻辑。</p>
<h1 id="配置中心客户端逻辑"><a href="#配置中心客户端逻辑" class="headerlink" title="配置中心客户端逻辑"></a>配置中心客户端逻辑</h1><h3 id="1-客户端流程概览"><a href="#1-客户端流程概览" class="headerlink" title="1.客户端流程概览"></a>1.客户端流程概览</h3><p>客户端整体流程可以进一步简化为：</p>
<ul>
<li><p>客户端通过长轮询的方式比较配置内容md5变更</p>
</li>
<li><p>长轮询通过从阻塞队列不断获取元素判断是否立即执行</p>
</li>
<li><p>阻塞队列无元素等待5秒执行</p>
</li>
</ul>
<p><img src="https://gitee.com/laoliangcode/md-picture/raw/master/img/20210803194741.png"></p>
<h3 id="2-Listener注册逻辑"><a href="#2-Listener注册逻辑" class="headerlink" title="2.Listener注册逻辑"></a>2.Listener注册逻辑</h3><p> 客户端Listener注册逻辑可以进一步简化为：</p>
<ul>
<li>客户端缓存了CacheData</li>
<li>阻塞队列中添加了元素new Object()</li>
</ul>
<p><img src="https://gitee.com/laoliangcode/md-picture/raw/master/img/20210803194818.png"></p>
<h3 id="3-配置变更检测逻辑"><a href="#3-配置变更检测逻辑" class="headerlink" title="3.配置变更检测逻辑"></a>3.配置变更检测逻辑</h3><p>客户端长轮询逻辑，可以进一步简化为：</p>
<ul>
<li>客户端收到服务端推送的变更事件后发起MD5校验</li>
<li>客户端主动向服务端发起MD5校验</li>
</ul>
<p><img src="https://gitee.com/laoliangcode/md-picture/raw/master/img/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%A2%E6%88%B7%E7%AB%AFListener%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%912.png"></p>
<h3 id="4-阻塞队列添加时机"><a href="#4-阻塞队列添加时机" class="headerlink" title="4.阻塞队列添加时机"></a>4.阻塞队列添加时机</h3><p><img src="https://gitee.com/laoliangcode/md-picture/raw/master/img/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%91%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E6%B7%BB%E5%8A%A0%E6%97%B6%E6%9C%BA2.png"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/4ce86841/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/6e152957/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/6e152957/" class="post-title-link" itemprop="url">Nacos14# 配置管理服务端流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-21 11:55:01" itemprop="dateCreated datePublished" datetime="2021-08-21T11:55:01+08:00">2021-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-01 14:11:03" itemprop="dateModified" datetime="2021-08-01T14:11:03+08:00">2021-08-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Nacos/" itemprop="url" rel="index"><span itemprop="name">Nacos</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>在上文分析中客户端会有长轮询，不断轮询阻塞队列「listenExecutebell」去比较客户端和服务端配置内容md5是否一致，不一致则通知我们注册的Listener完成回调。当阻塞队里有元素时会立即执行，没有元素等待5秒钟执行。那都在什么时候往队列中添加元素的从而触发立即执行。</p>
<h1 id="内容提要"><a href="#内容提要" class="headerlink" title="内容提要"></a>内容提要</h1><h3 id="长轮询回顾"><a href="#长轮询回顾" class="headerlink" title="长轮询回顾"></a>长轮询回顾</h3><ul>
<li>监听配置内容的变更通过长轮询实现</li>
<li>具体实现为轮询阻塞队列</li>
</ul>
<h3 id="阻塞队列添加时机"><a href="#阻塞队列添加时机" class="headerlink" title="阻塞队列添加时机"></a>阻塞队列添加时机</h3><ul>
<li>客户端添加Listener时添加</li>
<li>客户端删除Listener时添加</li>
<li>服务端通知内容变更时添加</li>
<li>建立gRPC连接时添加</li>
</ul>
<h3 id="服务端变更发布流程"><a href="#服务端变更发布流程" class="headerlink" title="服务端变更发布流程"></a>服务端变更发布流程</h3><ul>
<li>通过配置中心发起变更请求</li>
<li>配置变更内容被写入数据库</li>
<li>向本节点连接的Client发送变更通知</li>
<li>向集群中的其他节点发送变更通知</li>
</ul>
<h3 id="向Client发送变更通知"><a href="#向Client发送变更通知" class="headerlink" title="向Client发送变更通知"></a>向Client发送变更通知</h3><ul>
<li>首先构建DumpTask</li>
<li>处理DumpTask时发布ConfigDumpEvent事件</li>
<li>处理ConfigDumpEvent时发布LocalDataChangeEvent事件</li>
<li>处理LocalDataChangeEvent事件：@1 先从缓存中拿出注册Client列表 @2 根据client从缓存获取gRPC连接 @3 构建ConfigChangeNotifyRequest @4 通过gRPC向客户端发送变更通知</li>
<li>客户端处理变更通知，客户端接到请求后向阻塞队列添加new Object元素，详细客户端的长轮询流程见上篇</li>
</ul>
<h3 id="向其他节点发送变更通知"><a href="#向其他节点发送变更通知" class="headerlink" title="向其他节点发送变更通知"></a>向其他节点发送变更通知</h3><ul>
<li>通过gRPC向集群中其他节点发送变更通知</li>
<li>集群节点收到变更通知后再下发给连接自己的Client</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/6e152957/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/0/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-20 16:45:28" itemprop="dateCreated datePublished" datetime="2021-08-20T16:45:28+08:00">2021-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-12 11:50:17" itemprop="dateModified" datetime="2022-01-12T11:50:17+08:00">2022-01-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">title: Mesh8# Envoy原理提点与常用命令</span><br><span class="line">categories: Mesh</span><br><span class="line">tags: Mesh</span><br><span class="line">date: 2021-12-12 11:55:01</span><br></pre></td></tr></table></figure>





<h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><p>Istio的核心组件，作为sideCar与应用部署在一个Pod中，作为代理流量的进出均需经过Envoy所在的容器，除了代理外还可根据规则进行流量治理、监控等功能。</p>
<p><strong>Upstream Host:</strong> 上游主机，接受envoy的连接和请求并返回响应</p>
<p><strong>Downstream Host:</strong> 下游主机，向envoy发起请求并接受响应</p>
<p><strong>Enovy Mesh:</strong> 由一组Envoy组成的拓扑网络</p>
<p>**Listener: **  监听器负责监听数据端口，接受下游的连接和请求，下游主机通过Listener连接Envoy</p>
<p>**Cluster: ** 集群管理后端服务服务的连接池、服务的健康检查、服务熔断等</p>
<p><strong>Filter：</strong> 支持多种过滤器Listener Filter、Network Filter、L7 Filter等，组成filter链条，执行不同的流量治理逻辑。</p>
<p><strong>协议支持：</strong> </p>
<p>L3/L4网络代理，支持TCP、HTTP代理和TLS认证</p>
<p>L7代理，支持Buffer、限流等高级功能</p>
<p>L7路由，支持通过路径、权限、请求内容、运行时间等参数重定向路由请求</p>
<p>在HTTP模式下支持HTTP1.1和HTTP/2，同时支持基于HTTP/2的gRPC</p>
<p><strong>线程模型</strong> </p>
<p>一个Envoy进程包括一个Server主线程和一个GuardDog守护线程</p>
<p>Server主线程：负责管理Access Log以及解析上游主机的DNS。Access Log根据配置信息访问来处理Enovy访问记录，DNS解析将统一配置的域名解析成IP并缓存在本地DNS缓存中。</p>
<p>一个Envoy进程可以配置多个Listener，推荐配置一个，每个Listener可创建若干线程默认为核数，每个线程对应一个Worker。</p>
<p>一旦某个客户端连接进入Envoy中的某个线程，则连接断开之前的逻辑都在该线程内处理。例如：处理Client请求对应的TCP filter，解析协议和重新编码，与上游主机建立连接并处理返回数据等。</p>
<p><strong>内存管理</strong> </p>
<p>内存管理分为变量管理和Buffer管理：</p>
<ul>
<li>变量管理：C++运行过程中创建的实例</li>
<li>Buffer管理：数据接收、编解码等过程中临时存储数据的Buffer，通过malloc分配</li>
</ul>
<p><strong>流量控制</strong> </p>
<ul>
<li>如果上游主机处理过慢会在buffer积压，通过设置上下水位的阈值来控制</li>
<li>通过Envoy设置全局连接数来限制</li>
</ul>
<p><strong>主要模块</strong> </p>
<ul>
<li>Network模块 抽象Socket提供读写功能</li>
<li>Network Filter模块 过滤数据流量Listener Filter、Read Filter、Write Filter</li>
<li>L7 protocol模块包含HTTP、HTTP/2、gRPC</li>
<li>L7 filters模块与HTTP相关的认证、限流、路由等</li>
<li>Server Manager模块管理Worker管理、启动管理、配置管理和日志等</li>
<li>L7 Connection Manager模块包括建立连接、复用连接等功能</li>
<li>Cluster Manger模块集群管理模块包括hosts管理、负载均衡、健康检查等</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/0/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-20 16:45:28" itemprop="dateCreated datePublished" datetime="2021-08-20T16:45:28+08:00">2021-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-12 11:50:17" itemprop="dateModified" datetime="2022-01-12T11:50:17+08:00">2022-01-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">title: Mesh1# istio安装与部署</span><br><span class="line">categories: ServiceMesh</span><br><span class="line">tags: ServiceMesh</span><br><span class="line">date: 2021-09-21 11:55:01</span><br></pre></td></tr></table></figure>



<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>Istio作为service mesh控制面的实施标准，先部署起来。然而会有一个坑要注意，否则无法访问到页面。这个坑是个示例的bug，已被人提了issue，我也被坑了一把。</p>
<h1 id="一、准备工作"><a href="#一、准备工作" class="headerlink" title="一、准备工作"></a>一、准备工作</h1><p><strong>1.安装Docker</strong> </p>
<p>通过命令行或者直接下载，由于网络原因我直接下载安装 ，下载地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;hub.docker.com&#x2F;editions&#x2F;community&#x2F;docker-ce-desktop-mac</span><br></pre></td></tr></table></figure>



<p><strong>2.驱动安装</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https:&#x2F;&#x2F;storage.googleapis.com&#x2F;minikube&#x2F;releases&#x2F;latest&#x2F;docker-machine-driver-hyperkit</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x docker-machine-driver-hyperkit</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mv docker-machine-driver-hyperkit &#x2F;usr&#x2F;local&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown root:wheel &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-machine-driver-hyperkit</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod u+s &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-machine-driver-hyperkit</span><br></pre></td></tr></table></figure>



<p><strong>3.安装minikube</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -Lo minikube https:&#x2F;&#x2F;storage.googleapis.com&#x2F;minikube&#x2F;releases&#x2F;latest&#x2F;minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube &#x2F;usr&#x2F;local&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>验证版本</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ minikube version</span><br><span class="line">minikube version: v1.22.0</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/0/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-20 16:45:28" itemprop="dateCreated datePublished" datetime="2021-08-20T16:45:28+08:00">2021-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-12 11:50:17" itemprop="dateModified" datetime="2022-01-12T11:50:17+08:00">2022-01-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">title: Mesh2# 第三方注册中心集成istio</span><br><span class="line">categories: Mesh</span><br><span class="line">tags: Mesh</span><br><span class="line">date: 2021-09-21 11:55:01</span><br></pre></td></tr></table></figure>



<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>公司往往有自己的注册中心，有的使用Nacos、zookeeper等，还有自研的。这些在istio体系外的注册中心需要融入网格体系，让注册中心以及配置中心事件通知到istio，进而通过istio下发到数据面去。</p>
<p>第三方注册中心集成到istio通常有三种做法：</p>
<ul>
<li><p>方式一  修改源码实现serviceregistry.Instance接口适配到service controller</p>
</li>
<li><p>方式二  通过自定义MCP Server，例如：Nacos提供了这部分实现</p>
</li>
<li><p>方式三  将第三方注册中心事件封装成istio的ServiceEntry和WorkloadEntry资源写入Kubernetes的api server</p>
<p>istiod收到监听后完成转换</p>
</li>
</ul>
<p>方式一需要修改istio源码，重度耦合后续升级istio比较困难；方式二看着比较简单却调试比较困难给开发造成障碍；方式三从业界实践来看采用的最为广泛。</p>
<p>本文将分析第三种方式如何集成istio的，在此之前需要先走查下kubernetes的大体架构。</p>
<h1 id="一、k8s架构简述"><a href="#一、k8s架构简述" class="headerlink" title="一、k8s架构简述"></a>一、k8s架构简述</h1><h3 id="架构与概念"><a href="#架构与概念" class="headerlink" title="架构与概念"></a>架构与概念</h3><p><img src="https://gitee.com/laoliangcode/md-picture/raw/master/img/k8s%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86.png"></p>
<p><strong>kube-apiserver：</strong> 与Kubernetes资源交互的入口，可以通过kubectl或者client-go其他语言类库进行访问</p>
<p><strong>kube-scheduler:</strong>   负责资源调度与计算，将Pod按照特定策略分发到计算节点</p>
<p><strong>etcd：</strong> 键值存储数据库，保存Kubernetes集群相关数据</p>
<p><strong>kube-controller-manager:</strong>  运行一系列列控制器的组件，比如：节点控制器、任务控制器、端点控制器等</p>
<p><strong>kubelete：</strong> 运行在计算节点中，通过监听控制面接受指令，在节点内执行操作</p>
<p><strong>kube-proxy:</strong> 运行在计算节点的网络代理，负责Pod内外的网络通信代理</p>
<h3 id="Pods创建流程"><a href="#Pods创建流程" class="headerlink" title="Pods创建流程"></a>Pods创建流程</h3><ul>
<li>通过kubectl或者client-go类库向kube-apiserver发起创建请求</li>
<li>kube-apiserver将请求信息持久化在etcd数据库</li>
<li>kube-scheduler检测到请求后，计算Pod应该分配到哪个Node，并将分配策略写入etcd数据库</li>
<li>Kubelet检测到etcd的分配策略后，执行该策略调用docker相关api创建container</li>
</ul>
<h1 id="二、第三方注册中心集成"><a href="#二、第三方注册中心集成" class="headerlink" title="二、第三方注册中心集成"></a>二、第三方注册中心集成</h1><h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><p><img src="https://gitee.com/laoliangcode/md-picture/raw/master/img/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%BA%8B%E4%BB%B6%E8%BD%AC%E6%8D%A2%E4%B8%BAistio.png"></p>
<p><strong>转换流程：</strong> </p>
<p>从注册中心（Zookeeper）获取变更事件，将其转换为ServiceEntry写入kube-apiserver；Istiod（Pilot）通过监听kube-apiserver收到ServiceEntry后经过转换通过xDS下发给数据面。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/0/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-20 16:45:28" itemprop="dateCreated datePublished" datetime="2021-08-20T16:45:28+08:00">2021-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-12 11:50:17" itemprop="dateModified" datetime="2022-01-12T11:50:17+08:00">2022-01-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">title: Mesh7# wasm扩展Envoy使用详解</span><br><span class="line">categories: Mesh</span><br><span class="line">tags: Mesh</span><br><span class="line">date: 2021-11-07 11:55:01</span><br></pre></td></tr></table></figure>



<h1 id="一、wasm工作原理"><a href="#一、wasm工作原理" class="headerlink" title="一、wasm工作原理"></a>一、wasm工作原理</h1><p>我们想要网格的服务发现、路由、熔断降级、负载均衡，这些流量治理都在数据面Envoy中执行才行。Envoy也提供的Filter机制来做这些功能，通常有以下方式：</p>
<ul>
<li>通过C++代码自定义filter重新编译Envoy</li>
<li>使用Lua脚本扩展filter</li>
<li>使用wasm扩展Envoy</li>
</ul>
<p>第一种C++编译学习成本过高，维护也困难，第二种适合用于实现简单功能可以，第三种是重点发展方向通过其他语言编写filter，通过wasm编译运行嵌入在Envoy中运行，通过可移植的二进制指令实现，以下特性：</p>
<ul>
<li>动态加载到Envoy中执行</li>
<li>无需修改Envoy代码容易维护</li>
<li>支持较多开发语言比如tinygo</li>
<li>进程级隔离在VM沙箱运行部影响Envoy进程</li>
</ul>
<p>流量进过Envoy示意图:</p>
<p><img src="https://gitee.com/laoliangcode/md-picture/raw/master/img/wasm%20filter%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E7%A4%BA%E6%84%8F%E5%9B%BE.png"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/0/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-20 16:45:28" itemprop="dateCreated datePublished" datetime="2021-08-20T16:45:28+08:00">2021-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-12 11:50:17" itemprop="dateModified" datetime="2022-01-12T11:50:17+08:00">2022-01-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">title: Mesh3# Envoy代理转发与xDS映射关系</span><br><span class="line">categories: Mesh</span><br><span class="line">tags: Mesh</span><br><span class="line">date: 2021-10-15 11:55:01</span><br></pre></td></tr></table></figure>



<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>Envoy作为Istio默认数据面代理，它的工作流程是怎么样的？本文通过示例运行，走查其运行流程，以及xDS协议映射。</p>
<h1 id="xDS"><a href="#xDS" class="headerlink" title="xDS"></a>xDS</h1><p><strong>xDS</strong>  协议是“X Discovery Service”的简写，这里的“X”表示它不是指具体的某个协议，是一组基于不同数据源的服务发现协议的总称，包括 CDS、LDS、EDS、RDS等。在Istio架构中，基于xDS协议提供了标准的控制面规范，并以此向数据面传递服务信息和治理规则。在Envoy中，xDS被称为数据平面 API，并且担任控制平面Pilot和数据平面Envoy的通信协议。</p>
<p><strong>CDS</strong>  是 Cluster Discovery Service的缩写，Envoy使用它在进行路由的时候发现上游Cluster。Envoy通常会优雅地添加、更新和删除 Cluster。有了 CDS 协议，Envoy在初次启动的时候不一定要感知拓扑里所有的上游Cluster。在做路由 HTTP 请求的时候通过在 HTTP 请求头里添加 Cluster信息实现请求转发。</p>
<p><strong>EDS</strong> 即Endpoint Discovery Service 的缩写。在Envoy术语中，Endpoint即Cluster的成员。Envoy 通过 EDS API可以更加智能地动态获取上游Endpoint。</p>
<p><strong>LDS</strong>  即Listener Discovery Service的缩写。基于此，Envoy 可以在运行时发现所有的Listener，包括 L3 和 L4 filter 等所有的 filter 栈，并由此执行各种代理工作，如认证、TCP 代理和 HTTP 代理等。添加 LDS 使得 Envoy 的任何配置都可以动态执行。</p>
<p><strong>RDS</strong>  即 Router Discovery Service 的缩写，用于 Envoy 在运行时为 HTTP 连接管理 filter 获取完整的路由配置，比如 HTTP 头部修改等。并且路由配置会被优雅地写入而无需影响已有的请求。当 RDS 和 EDS、CDS 共同使用时，可以帮助构建一个复杂的路由拓扑蓝绿发布等。</p>
<p><strong>ADS</strong>  EDS，CDS 等每个独立的服务都对应了不同的 gRPC 服务名称。对于需要控制不同类型资源抵达 Envoy 顺序的需求，可以使用聚合发现服务，即 Aggregated xDS，它可以通过单一的 gRPC 服务流支持所有的资源类型，借助于有序的配置分发，从而解决资源更新顺序的问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">备注：上述概念摘自 https:&#x2F;&#x2F;www.servicemesher.com&#x2F;istio-handbook&#x2F;ecosystem&#x2F;xds.html</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/0/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-20 16:45:28" itemprop="dateCreated datePublished" datetime="2021-08-20T16:45:28+08:00">2021-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-12 11:50:17" itemprop="dateModified" datetime="2022-01-12T11:50:17+08:00">2022-01-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">title: Mesh5# Istio服务模型与流量治理要点</span><br><span class="line">categories: Mesh</span><br><span class="line">tags: Mesh</span><br><span class="line">date: 2021-10-16 11:55:01</span><br></pre></td></tr></table></figure>



<h1 id="Istio服务模型"><a href="#Istio服务模型" class="headerlink" title="Istio服务模型"></a>Istio服务模型</h1><p>服务（Service）与版本（Version）：Istio中的服务在kubernetes中以service形式存在，可定义不同的服务版本。通过Deployment创建工作负载，通过Service关联这些负载，域名或者虚拟IP访问后端Pod。</p>
<p>服务实例（ServiceInstance）: 一个服务可以包含一组实例，在Kubernetes中用Endpoints实现，一组域名或者IP地址。</p>
<p><img src="https://gitee.com/laoliangcode/md-picture/raw/master/img/Istio%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9E%8B.drawio.png"></p>
<p><strong>服务（Service）示例：</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: helloworld</span><br><span class="line">  labels:</span><br><span class="line">    app: helloworld</span><br><span class="line">    service: helloworld</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 5000</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: helloworld</span><br></pre></td></tr></table></figure>

<p>备注：创建一个名称为helloworld的Service，指向“app: helloworld”的Pods，Kubernetes会自动创建一个和Service同名的Endpoints对象，Selector会持续跟踪映射属于helloworld的Pods。</p>
<p><strong>工作负载示例：</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: helloworld-v1</span><br><span class="line">  labels:</span><br><span class="line">    app: helloworld</span><br><span class="line">    version: v1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: helloworld</span><br><span class="line">      version: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: helloworld</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: helloworld</span><br><span class="line">        image: docker.io&#x2F;istio&#x2F;examples-helloworld-v1</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">        imagePullPolicy: IfNotPresent #Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5000</span><br></pre></td></tr></table></figure>

<p>备注：以Deployment方式创建工作负载，关联的版本与镜像。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/4734254d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/4734254d/" class="post-title-link" itemprop="url">MQ45# 实战|RocketMQ不同可用区导致消费不均衡</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-15 20:55:01" itemprop="dateCreated datePublished" datetime="2021-08-15T20:55:01+08:00">2021-08-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-12 11:50:16" itemprop="dateModified" datetime="2022-01-12T11:50:16+08:00">2022-01-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="现象反馈"><a href="#现象反馈" class="headerlink" title="现象反馈"></a>现象反馈</h1><p>业务同学反馈有个服务在部署容器后不间断收到积压告警，该服务对积压敏感，影响派单的时效性。原来部署到ECS上的服务没有积压情况，准备往容器迁移。下面是业务同学做的排除测试，另外容器当前在J/K可用区部署，而MQ集群部署在B/G/F区。</p>
<ul>
<li>回退到原ECS部署积压消失</li>
<li>在原可用区申请扩容ECS未出现积压</li>
<li>在新的可用区J/K申请ECS出现积压</li>
</ul>
<p><strong>备注：</strong> 很明显该积压与可用区有关系。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/4734254d/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yongliangcode.github.io/posts/11be6e51/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="瓜农老梁">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/11be6e51/" class="post-title-link" itemprop="url">Nacos13# 配置管理客户端流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-15 11:55:01" itemprop="dateCreated datePublished" datetime="2021-08-15T11:55:01+08:00">2021-08-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-01 14:11:03" itemprop="dateModified" datetime="2021-08-01T14:11:03+08:00">2021-08-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Nacos/" itemprop="url" rel="index"><span itemprop="name">Nacos</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>Nacos注册中心的主要流程基本上撸完了，下面开始撸配置中心。本文从示例入手走查了客户端的初始化流程，Listener的注册逻辑和执行逻辑。</p>
<h1 id="内容提要"><a href="#内容提要" class="headerlink" title="内容提要"></a>内容提要</h1><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><ul>
<li>通过示例构建ConfigService、注册了Listener分析其流程</li>
</ul>
<h3 id="Client初始化概览"><a href="#Client初始化概览" class="headerlink" title="Client初始化概览"></a>Client初始化概览</h3><ul>
<li>支持多种获取server地址方式（本地、endpoint）</li>
<li>支持多种namespace设置（本地、阿里云）</li>
<li>支持超时时间、重试时间等参数设置</li>
<li>支持用户名和密码验证</li>
<li>长轮询会从BlockingQueue中获取元素，队列有元素立即执行executeConfigListen，队列无元素阻塞5秒钟执行executeConfigListen()</li>
</ul>
<h3 id="Listener注册逻辑"><a href="#Listener注册逻辑" class="headerlink" title="Listener注册逻辑"></a>Listener注册逻辑</h3><ul>
<li>client添加Listener后会在cacheMap中缓存CacheData</li>
<li>cacheMap中key由「dataId+group+tenant」拼接而成</li>
<li>每个CacheData会绑定注册的Listener列表</li>
<li>每个CacheData会绑定taskId，3000个不同的CacheData对应一个taskId</li>
<li>设置isSyncWithServer=false表示 cache md5 data不是来自server同步</li>
<li>BlockingQueue中添加new Object() 供长轮询判断立即执行使用</li>
</ul>
<h3 id="配置变更执行逻辑"><a href="#配置变更执行逻辑" class="headerlink" title="配置变更执行逻辑"></a>配置变更执行逻辑</h3><ul>
<li>执行逻辑由executeConfigListen方法实现</li>
<li>当CacheData从Server同步后，会校验md5是否变更了，变更则回调注册的Listener完成通知</li>
<li>注册Listener后会构建与server的RPC通道rpcClient</li>
<li>向server发起变更查询请求configChangeListenRequest</li>
<li>Server端通过比较缓存的md5值，返回client变更的key列表</li>
<li>Client通过变更的key列表向server发起配置查询请求ConfigQueryRequest</li>
<li>获取变更内容，并回调注册的Listener完成通知</li>
<li>回调注册的Listener是通过线程池异步执行Runnble Job实现的</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/posts/11be6e51/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://mp.weixin.qq.com/s/kPx7F1iD1lgvYiZ1_oymwQ" title="联系老梁 → https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;kPx7F1iD1lgvYiZ1_oymwQ" rel="noopener" target="_blank"><i class="fa fa-weixin fa-fw"></i>联系老梁</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
